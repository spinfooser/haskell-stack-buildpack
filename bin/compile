#!/bin/bash

set -eo pipefail

BUILDDIR=$1
CACHEDIR=$2
STACKCACHE=$CACHEDIR/stackcache
BINDIR=$CACHEDIR/bin
export PATH=$PATH:$BINDIR

mkdir -p $HOME/.cabal
mkdir -p $STACKCACHE
mkdir -p $BINDIR

pushd $CACHEDIR

echo "Downloading Stack Tool"
wget -qO- -O stack.tar.gz https://www.stackage.org/stack/linux-x86_64
tar xf stack.tar.gz
mv stack*linux-x86_64/stack $BINDIR

#apt-get install libgmp-dev
echo "Stack setup completed"

pushd $BUILDDIR
echo "Build Haskell compiler started"
stack setup --ghc-bindist http://downloads.haskell.org/~ghc/8.0.1/ghc-8.0.1-x86_64-deb8-linux.tar.xz
echo "Build Haskell compiler completed"

echo "App build started"
stack build
echo "App build completed"
popd
