#!/bin/bash

set -eo pipefail

BUILDDIR=$1
CACHEDIR=$2
BINDIR=$CACHEDIR/bin
export PATH=$PATH:$BINDIR

mkdir -p $BINDIR


pushd $CACHEDIR

echo "Downloading Stack Tool"
wget -qO- -O stack.tar.gz https://www.stackage.org/stack/linux-x86_64
tar xf stack.tar.gz
mv stack*linux-x86_64/stack $BINDIR

#apt-get install libgmp-dev
echo "Stack setup completed"

popd


echo "Using stack.yml file"
echo "======================================"
cat stack.yml
echo "======================================"


pushd $CACHEDIR

echo "Build Haskell compiler started"
stack setup --stack-setup-yaml $BUILDDIR/stack.yml
rm ~/.stack/programs/**/*.tar.bz2
echo "Build Haskell compiler completed"

popd


pushd $BUILDDIR

echo "App build started"
stack build
echo "App build completed"

popd
